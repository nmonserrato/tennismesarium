<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tournament details - Tennismesarium</title>
    <link rel="stylesheet" href="fixtures.css">
</head>
<body>
    <br />
    <br />
    <div id="tournamentNameLabel" class="header"></div>
    <div id="tournamentWinnerName" class="sub-header"></div>
    <input type="hidden" id="tournamentIdInput" />

    <div class="bracket-container">

    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>

    <script src="common.js"></script>

    <script type="application/javascript">
        function drawRound(round) {
            $('.bracket-container').append("<h3>Round "+round.sequence+"</h3>");
            var table = $('<table>')
            table.append("<thead><tr><th>HOME</th><th></th><th>AWAY</th></tr></thead>");
            var tbody = $('<tbody>')

            for (i = 0; i < round.matches.length; i++) {
                match = round.matches[i];
                var p1 = match.players[0];
                var p2 = match.players[1];
                var p1Text = p1.name;
                var p2Text = p2.name;
                if (match.canBePlayed) {
                    p1Text = '<a href="#" onclick="submitMatchResult(\''+match.id+'\',\''+p1.id+'\',\''+p1.name+'\');return false;">'+p1.name+'</a>';
                    p2Text = '<a href="#" onclick="submitMatchResult(\''+match.id+'\',\''+p2.id+'\',\''+p2.name+'\');return false;">'+p2.name+'</a>';
                } else {
                    if (p1.id == match.winner.id)
                        p1Text = "<b>"+p1.name+"</b>";
                    else
                        p2Text = "<b>"+p2.name+"</b>";
                }

                var tr = $('<tr>')
                tr.append('<td>'+p1Text+'</td><td>vs</td><td>'+p2Text+'</td>');
                tbody.append(tr);
            }

            table.append(tbody);
            $('.bracket-container').append(table);
        }

        function drawTables(tables) {
            $('.bracket-container').append("<hr /><h3>Tables</h3>");
            var table = $('<table>')
            table.append("<thead><tr><th>NAME</th><th>PLAYED</th><th>WON</th><th>LOST</th><th>STREAK</th><th>POINTS</th></tr></thead>");
            var tbody = $('<tbody>')
            for (i = 0; i < tables.length; i++) {
                var name = tables[i].playerName;
                var stats = tables[i].stats;
                var tr = $('<tr>')
                tr.append("<td><b>"+name+"</b></td>");
                tr.append("<td>"+stats.played+"</td>");
                tr.append("<td>"+stats.won+"</td>");
                tr.append("<td>"+stats.lost+"</td>");
                tr.append("<td>"+stats.bestStreak+"</td>");
                tr.append("<td><b>"+stats.points+"</b></td>");
                tbody.append(tr)
            }
            table.append(tbody);
            $('.bracket-container').append(table);
        }

        function drawInfoAndRounds(data) {
            $('#tournamentNameLabel').html("<h1>" + data.name + "</h1>");
            $('#tournamentIdInput').val(data.id);

            if (typeof data.winner !== 'undefined') {
                $('#tournamentWinnerName').html("<h2>Winner: " + data.winner.name + "</h2>");
            }

            $('.bracket-container').html("");

            drawRound(data.rounds[data.currentRound]);
            drawTables(data.tables);
        }

        function reloadTree() {
            var tournamentId = urlParam("id");
            $.getJSON( "/api/tournament/"+tournamentId, function( data ) {
                drawInfoAndRounds(data);
            });
        }

        reloadTree();
    </script>
</body>
</html>
